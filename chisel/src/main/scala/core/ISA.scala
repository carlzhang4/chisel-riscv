package core

import chisel3._
import chisel3.util._


object SrcType {
  def reg = "b0".U
  def pc  = "b1".U
  def imm = "b1".U
  def apply() = UInt(1.W)
}

trait HasInstType{
	def InstN  = "b0000".U
	def InstI  = "b0001".U
	def InstR  = "b0010".U
	def InstS  = "b0011".U
	def InstB  = "b0100".U
	def InstU  = "b0101".U
	def InstJ  = "b0110".U	
}

object FUType{
  def alu = "b000".U
  def lsu = "b001".U
  def bru = "b101".U
  def csr = "b011".U

  def apply() = UInt(3.W)
}


object FUOpType {
	def add  = "b1000000".U
	def sll  = "b0000001".U
	def slt  = "b0000010".U
	def sltu = "b0000011".U
	def xor  = "b0000100".U
	def srl  = "b0000101".U
	def or   = "b0000110".U
	def and  = "b0000111".U
	def sub  = "b0001000".U
	def sra  = "b0001101".U

	def jal  = "b1011000".U
	def jalr = "b1011010".U
	def beq  = "b0010000".U
	def bne  = "b0010001".U
	def blt  = "b0010100".U
	def bge  = "b0010101".U
	def bltu = "b0010110".U
	def bgeu = "b0010111".U

	//todo
	def lb		=	"b0100000".U
	def lh		=	"b0100001".U
	def lw		=	"b0100010".U
	def lbu		=	"b0100011".U
	def lhu		=	"b0100100".U
	def sb		=	"b0100101".U
	def sh		=	"b0100110".U
	def sw		=	"b0100111".U


	def jmp  	= 	"b0111111".U

	def apply() = UInt(7.W)
	def isAdd(func:UInt) = func(6) //only add return true among arithmatic insts
	// def isWordOp(func: UInt) = func(5)
	// def isAdd(func: UInt) = func(6)
	// def pcPlus2(func: UInt) = func(5)
	// def isBru(func: UInt) = func(4)
	// def isBranch(func: UInt) = !func(3)
	// def isJump(func: UInt) = isBru(func) && !isBranch(func)
	// def getBranchType(func: UInt) = func(2, 1)
  	// def isBranchInvert(func: UInt) = func(0)
}

object RV32I_Inst extends HasInstType{
	def LUI		=	BitPat("b????????????????????_?????_0110111")
	def AUIPC	=	BitPat("b????????????????????_?????_0010111")
	def JAL		=	BitPat("b????????????????????_?????_1101111")
	def JALR    =	BitPat("b????????????_?????_000_?????_1100111")

	def BEQ     =	BitPat("b???????_?????_?????_000_?????_1100011")
	def BNE     =	BitPat("b???????_?????_?????_001_?????_1100011")
	def BLT     = 	BitPat("b???????_?????_?????_100_?????_1100011")
  	def BGE     = 	BitPat("b???????_?????_?????_101_?????_1100011")
  	def BLTU    = 	BitPat("b???????_?????_?????_110_?????_1100011")
  	def BGEU    = 	BitPat("b???????_?????_?????_111_?????_1100011")

	def LB      =	BitPat("b????????????_?????_000_?????_0000011")
	def LH      =	BitPat("b????????????_?????_001_?????_0000011")
	def LW      =	BitPat("b????????????_?????_010_?????_0000011")
	def LBU     =	BitPat("b????????????_?????_100_?????_0000011")
	def LHU     =	BitPat("b????????????_?????_101_?????_0000011")
	def SB      =	BitPat("b???????_?????_?????_000_?????_0100011")
	def SH      =	BitPat("b???????_?????_?????_001_?????_0100011")
	def SW      =	BitPat("b???????_?????_?????_010_?????_0100011")

	

	def ADDI	=	BitPat("b????????????_?????_000_?????_0010011") //done
	def SLTI 	=	BitPat("b????????????_?????_010_?????_0010011") //
	def SLTIU   = 	BitPat("b????????????_?????_011_?????_0010011") //
	def XORI    = 	BitPat("b????????????_?????_100_?????_0010011") //
	def ORI     = 	BitPat("b????????????_?????_110_?????_0010011") //
	def ANDI    = 	BitPat("b????????????_?????_111_?????_0010011") //
	def SLLI    = 	BitPat("b0000000?????_?????_001_?????_0010011") //
	def SRLI    = 	BitPat("b0000000?????_?????_101_?????_0010011") //
	def SRAI    = 	BitPat("b0100000?????_?????_101_?????_0010011") //

	def ADD     = 	BitPat("b0000000_?????_?????_000_?????_0110011") //
	def SUB     = 	BitPat("b0100000_?????_?????_000_?????_0110011") //
	def SLL     = 	BitPat("b0000000_?????_?????_001_?????_0110011") // 
  	def SLT     = 	BitPat("b0000000_?????_?????_010_?????_0110011") //
	def SLTU    = 	BitPat("b0000000_?????_?????_011_?????_0110011") //
  	def XOR     = 	BitPat("b0000000_?????_?????_100_?????_0110011") //
  	def SRL     = 	BitPat("b0000000_?????_?????_101_?????_0110011") //
  	def SRA     = 	BitPat("b0100000_?????_?????_101_?????_0110011") //
  	def OR      = 	BitPat("b0000000_?????_?????_110_?????_0110011") //
  	def AND     = 	BitPat("b0000000_?????_?????_111_?????_0110011") //
	
	val table = Array(
		LUI        		-> List(InstU, FUType.alu, FUOpType.add),
		AUIPC      		-> List(InstU, FUType.alu, FUOpType.add),
		JAL        		-> List(InstJ, FUType.bru, FUOpType.jal),
    	JALR       		-> List(InstI, FUType.bru, FUOpType.jalr),

		BEQ				-> List(InstB, FUType.bru, FUOpType.beq),
		BNE				-> List(InstB, FUType.bru, FUOpType.bne),
		BLT				-> List(InstB, FUType.bru, FUOpType.blt),
		BGE				-> List(InstB, FUType.bru, FUOpType.bge),
		BLTU			-> List(InstB, FUType.bru, FUOpType.bltu),
		BGEU			-> List(InstB, FUType.bru, FUOpType.bgeu),

		LB				-> List(InstI, FUType.lsu, FUOpType.lb ),
		LH				-> List(InstI, FUType.lsu, FUOpType.lh ),
		LW				-> List(InstI, FUType.lsu, FUOpType.lw ),
		LBU				-> List(InstI, FUType.lsu, FUOpType.lbu),
		LHU				-> List(InstI, FUType.lsu, FUOpType.lhu),
		SB				-> List(InstS, FUType.lsu, FUOpType.sb ),
		SH				-> List(InstS, FUType.lsu, FUOpType.sh ),
		SW				-> List(InstS, FUType.lsu, FUOpType.sw ),

		ADDI			-> List(InstI, FUType.alu, FUOpType.add),
		SLTI			-> List(InstI, FUType.alu, FUOpType.slt),
		SLTIU			-> List(InstI, FUType.alu, FUOpType.sltu),
		XORI			-> List(InstI, FUType.alu, FUOpType.xor),
		ORI				-> List(InstI, FUType.alu, FUOpType.or ),
		ANDI			-> List(InstI, FUType.alu, FUOpType.and),
		SLLI			-> List(InstI, FUType.alu, FUOpType.sll),
		SRLI			-> List(InstI, FUType.alu, FUOpType.srl),
		SRAI			-> List(InstI, FUType.alu, FUOpType.sra),

		ADD				-> List(InstR, FUType.alu, FUOpType.add),
		SUB				-> List(InstR, FUType.alu, FUOpType.sub),
		SLL				-> List(InstR, FUType.alu, FUOpType.sll),
		SLT				-> List(InstR, FUType.alu, FUOpType.slt),
		SLTU			-> List(InstR, FUType.alu, FUOpType.sltu),
		XOR				-> List(InstR, FUType.alu, FUOpType.xor),
		SRL				-> List(InstR, FUType.alu, FUOpType.srl),
		SRA				-> List(InstR, FUType.alu, FUOpType.sra),
		OR				-> List(InstR, FUType.alu, FUOpType.or ),
		AND				-> List(InstR, FUType.alu, FUOpType.and),

	)
}

object Instructions extends HasInstType{
	val DecodeTable		= RV32I_Inst.table

	val DecodeDefault	= List(InstN, FUType.csr, FUOpType.jmp)//todo
}